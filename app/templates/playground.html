<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground de Agentes Agno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body { background-color: #1a202c; color: #e2e8f0; }
        .header, .footer { background-color: #2d3748; }
        .card { background-color: #2d3748; border: 1px solid #4a5568; }
        .chat-bubble { background-color: #4a5568; }
        .chat-bubble.user { background-color: #38a169; }
        .config-editor { height: 400px; }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center text-white mb-6">Playground de Agentes</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Coluna de Configuração -->
            <div>
                <div class="card p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Configuração da Equipe</h2>
                    <div class="mb-4">
                        <label for="user-id" class="block text-sm font-medium text-gray-400">User ID</label>
                        <input type="text" id="user-id" class="w-full p-2 rounded bg-gray-800 text-white" value="user-playground">
                    </div>
                    <div class="mb-4">
                        <label for="instance-id" class="block text-sm font-medium text-gray-400">Instance ID</label>
                        <input type="text" id="instance-id" class="w-full p-2 rounded bg-gray-800 text-white" value="instance-playground">
                    </div>
                    <textarea id="config-editor" class="w-full p-2 rounded bg-gray-800 text-white config-editor"></textarea>
                    <button id="update-config-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Criar/Atualizar Equipe</button>
                </div>
            </div>

            <!-- Coluna de Chat -->
            <div>
                <div class="card p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Chat em Tempo Real</h2>
                    <div id="chat-box" class="h-96 overflow-y-auto p-2 border border-gray-600 rounded mb-4"></div>
                    <div class="flex">
                        <input type="text" id="message-input" class="flex-grow p-2 rounded-l bg-gray-800 text-white" placeholder="Digite sua mensagem...">
                        <button id="send-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-r">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const userIdInput = document.getElementById('user-id');
        const instanceIdInput = document.getElementById('instance-id');
        const configEditor = document.getElementById('config-editor');
        const updateConfigBtn = document.getElementById('update-config-btn');
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        let socket;

        // Exemplo de configuração inicial
        const initialConfig = {
            "router_instructions": "Você é um roteador inteligente. Delegue a tarefa para o especialista adequado.",
            "agents": [
                {
                    "name": "Analista Financeiro",
                    "role": "Especialista em análise de ações e dados financeiros.",
                    "model_provider": "GEMINI",
                    "model_id": "gemini-1.5-flash",
                    "tools": [
                        {
                            "type": "YFINANCE",
                            "config": { "stock_price": true, "company_news": true }
                        }
                    ]
                },
                {
                    "name": "Pesquisador Web",
                    "role": "Especialista em buscar informações na web.",
                    "model_provider": "GEMINI",
                    "model_id": "gemini-1.5-flash",
                    "tools": [
                        { "type": "DUCKDUCKGO" }
                    ]
                }
            ]
        };
        configEditor.value = JSON.stringify(initialConfig, null, 2);

        function connectWebSocket() {
            const userId = userIdInput.value;
            const instanceId = instanceIdInput.value;
            
            if (!userId || !instanceId) {
                alert('Por favor, preencha User ID e Instance ID.');
                return;
            }

            if (socket) {
                socket.close();
            }

            socket = new WebSocket(`ws://${window.location.host}/ws/chat?user_id=${userId}&instance_id=${instanceId}`);

            socket.onopen = () => {
                addMessageToChat('Conectado ao servidor.', 'system');
            };

            socket.onmessage = (event) => {
                addMessageToChat(event.data, 'agent');
            };

            socket.onclose = () => {
                addMessageToChat('Desconectado do servidor.', 'system');
            };
        }

        function addMessageToChat(message, sender) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', 'p-2', 'rounded', 'mb-2');
            if (sender === 'user') {
                bubble.classList.add('user', 'text-right');
            } else if (sender === 'system') {
                bubble.classList.add('text-center', 'text-gray-400', 'text-sm');
            } else {
                bubble.classList.add('agent');
            }
            bubble.textContent = message;
            chatBox.appendChild(bubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        sendBtn.addEventListener('click', () => {
            const message = messageInput.value;
            if (socket && socket.readyState === WebSocket.OPEN && message.trim() !== '') {
                socket.send(message);
                addMessageToChat(message, 'user');
                messageInput.value = '';
            }
        });

        updateConfigBtn.addEventListener('click', async () => {
            const userId = userIdInput.value;
            const instanceId = instanceIdInput.value;
            let config;
            try {
                config = JSON.parse(configEditor.value);
            } catch (e) {
                alert('Erro no formato JSON da configuração.');
                return;
            }

            const payload = {
                user_id: userId,
                instance_id: instanceId,
                ...config
            };

            const response = await fetch('/agent/hierarchy', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert('Configuração da equipe atualizada com sucesso!');
                connectWebSocket(); // Reconecta para usar a nova configuração
            } else {
                alert('Falha ao atualizar a configuração.');
            }
        });

        // Conecta ao carregar a página
        connectWebSocket();

    </script>

</body>
</html>