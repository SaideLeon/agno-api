<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground de Agentes Agno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #1a202c; color: #e2e8f0; }
        .header, .footer { background-color: #2d3748; }
        .card { background-color: #2d3748; border: 1px solid #4a5568; }
        .chat-bubble { background-color: #4a5568; }
        .chat-bubble.user { background-color: #38a169; }
        .config-editor { height: 400px; }
        .chat-bubble pre { background-color: #1f2937; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; }
        .chat-bubble code { font-family: monospace; }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center text-white mb-6">Playground de Agentes</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Coluna de Configuração -->
            <div>
                <div class="card p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Configuração da Equipe</h2>
                    <div class="mb-4">
                        <label for="user-id" class="block text-sm font-medium text-gray-400">User ID</label>
                        <input type="text" id="user-id" class="w-full p-2 rounded bg-gray-800 text-white" value="user-playground">
                    </div>
                    <div class="mb-4">
                        <label for="instance-id" class="block text-sm font-medium text-gray-400">Instance ID</label>
                        <input type="text" id="instance-id" class="w-full p-2 rounded bg-gray-800 text-white" value="instance-playground">
                    </div>
                    <textarea id="config-editor" class="w-full p-2 rounded bg-gray-800 text-white config-editor"></textarea>
                    <button id="update-config-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Criar/Atualizar Equipe</button>
                </div>
            </div>

            <!-- Coluna de Chat -->
            <div>
                <div class="card p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Chat em Tempo Real</h2>
                    <div id="chat-box" class="h-96 overflow-y-auto p-2 border border-gray-600 rounded mb-4"></div>
                    <div class="flex">
                        <input type="text" id="message-input" class="flex-grow p-2 rounded-l bg-gray-800 text-white" placeholder="Configure a equipe para começar..." disabled>
                        <button id="send-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-r disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const userIdInput = document.getElementById('user-id');
        const instanceIdInput = document.getElementById('instance-id');
        const configEditor = document.getElementById('config-editor');
        const updateConfigBtn = document.getElementById('update-config-btn');
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        let socket;

        const initialConfig = {
            "router_instructions": "Você é um roteador inteligente. Delegue a tarefa para o especialista adequado.",
            "agents": [
                {
                    "name": "Analista Financeiro",
                    "role": "Especialista em análise de ações e dados financeiros.",
                    "model_provider": "GEMINI",
                    "model_id": "gemini-1.5-flash",
                    "tools": [
                        {
                            "type": "YFINANCE",
                            "config": { "stock_price": true, "company_news": true }
                        }
                    ]
                },
                {
                    "name": "Pesquisador Web",
                    "role": "Especialista em buscar informações na web.",
                    "model_provider": "GEMINI",
                    "model_id": "gemini-1.5-flash",
                    "tools": [
                        { "type": "DUCKDUCKGO" }
                    ]
                }
            ]
        };
        configEditor.value = JSON.stringify(initialConfig, null, 2);

        function addMessageToChat(message, sender) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble p-2 rounded mb-2 ${
                sender === 'user' ? 'user text-right' : 
                sender === 'system' ? 'text-center text-gray-400 text-sm' : 'agent'
            }`;

            if (sender === 'user' || sender === 'system') {
                bubble.textContent = message;
            } else {
                bubble.innerHTML = marked.parse(message);
                bubble.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }

            chatBox.appendChild(bubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function setChatDisabled(disabled) {
            messageInput.disabled = disabled;
            sendBtn.disabled = disabled;
            messageInput.placeholder = disabled ? 'Configure a equipe para começar...' : 'Digite sua mensagem...';
        }

        async function criarOuAtualizarEquipe() {
            updateConfigBtn.disabled = true;
            updateConfigBtn.textContent = 'Atualizando...';

            const userId = userIdInput.value.trim();
            const instanceId = instanceIdInput.value.trim();
            
            if (!userId || !instanceId) {
                addMessageToChat('User ID e Instance ID são obrigatórios.', 'system');
                updateConfigBtn.disabled = false;
                updateConfigBtn.textContent = 'Criar/Atualizar Equipe';
                return;
            }

            let config;
            try {
                config = JSON.parse(configEditor.value);
            } catch (e) {
                addMessageToChat('Erro no formato JSON da configuração.', 'system');
                updateConfigBtn.disabled = false;
                updateConfigBtn.textContent = 'Criar/Atualizar Equipe';
                return;
            }

            const payload = { user_id: userId, instance_id: instanceId, ...config };

            try {
                const response = await fetch('/agent/hierarchy', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    addMessageToChat('Equipe atualizada com sucesso!', 'system');
                    conectarWebSocket(userId, instanceId);
                } else {
                    const errorData = await response.json();
                    addMessageToChat(`Falha ao atualizar: ${errorData.detail || response.statusText}`, 'system');
                }
            } catch (error) {
                addMessageToChat('Erro de rede ao atualizar a configuração.', 'system');
                console.error("Fetch Error:", error);
            } finally {
                updateConfigBtn.disabled = false;
                updateConfigBtn.textContent = 'Criar/Atualizar Equipe';
            }
        }

        function conectarWebSocket(userId, instanceId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.close();
            }

            const wsUrl = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/chat?user_id=${encodeURIComponent(userId)}&instance_id=${encodeURIComponent(instanceId)}`;
            socket = new WebSocket(wsUrl);

            addMessageToChat('Conectando ao servidor...', 'system');

            socket.onopen = () => {
                addMessageToChat('Conectado com sucesso! Pode começar a conversar.', 'system');
                setChatDisabled(false);
            };

            socket.onmessage = (event) => {
                addMessageToChat(event.data, 'agent');
            };

            socket.onerror = (error) => {
                addMessageToChat('Erro de conexão. Verifique o console para detalhes.', 'system');
                console.error("WebSocket Error:", error);
                setChatDisabled(true);
            };

            socket.onclose = () => {
                addMessageToChat('Desconectado do servidor.', 'system');
                setChatDisabled(true);
            };
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '') return;

            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
                addMessageToChat(message, 'user');
                messageInput.value = '';
            } else {
                addMessageToChat('Erro: Não conectado. Crie/atualize a equipe primeiro.', 'system');
            }
        }

        updateConfigBtn.addEventListener('click', criarOuAtualizarEquipe);
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        addMessageToChat('Bem-vindo ao Playground! Configure sua equipe e clique em "Criar/Atualizar Equipe" para começar.', 'system');
    </script>

</body>
</html>